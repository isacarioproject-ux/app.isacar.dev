â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ”§ FIX - ERRO DE WORKSPACE DUPLICADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… PROBLEMA RESOLVIDO

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ ERRO ORIGINAL:

```
Failed to load resource: the server responded with a status of 409 ()
âŒ Erro ao criar workspace: duplicate key value violates unique constraint 
"workspace_members_workspace_id_user_id_key"
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” CAUSA DO PROBLEMA:

1. UsuÃ¡rio faz login pela primeira vez
2. Vai para onboarding, passo 2 (workspace)
3. Cria workspace com sucesso
4. Tenta criar novamente (refresh ou volta ao passo)
5. ERRO 409: workspace_member jÃ¡ existe!

RAZÃƒO:
- A constraint "workspace_members_workspace_id_user_id_key" garante que
  um usuÃ¡rio sÃ³ pode estar uma vez em cada workspace
- Se tentar criar novamente, viola a constraint
- Status HTTP 409 = Conflict (conflito de recurso)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… SOLUÃ‡ÃƒO IMPLEMENTADA:

VERIFICAR ANTES DE CRIAR:

```typescript
// 1. Verificar se usuÃ¡rio jÃ¡ tem workspace
const { data: existingMembership } = await supabase
  .from('workspace_members')
  .select('workspace_id, workspaces(id, name, slug)')
  .eq('user_id', user.id)
  .limit(1)
  .maybeSingle()

// 2. Se jÃ¡ tem workspace, USAR O EXISTENTE
if (existingMembership && existingMembership.workspaces) {
  const workspace = existingMembership.workspaces
  console.log('âœ… Workspace jÃ¡ existe:', workspace.name)
  toast.success('Usando workspace existente!')
  
  onNext({
    workspaceName: workspace.name,
    workspaceId: workspace.id
  })
  return // PARAR AQUI, nÃ£o criar novo
}

// 3. Se NÃƒO tem workspace, CRIAR NOVO
console.log('ğŸ¢ Criando novo workspace:', name.trim())
// ... cÃ³digo de criaÃ§Ã£o ...
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”„ FLUXO CORRETO AGORA:

CENÃRIO 1: PRIMEIRO ACESSO
```
1. UsuÃ¡rio no passo 2 (workspace)
2. Digita nome e slug
3. Clica "Criar espaÃ§o de trabalho"
4. Verifica: workspace existe? NÃƒO
5. Cria novo workspace
6. Adiciona usuÃ¡rio como membro
7. AvanÃ§a para prÃ³ximo passo
```

CENÃRIO 2: REFRESH OU VOLTA AO PASSO
```
1. UsuÃ¡rio volta ao passo 2
2. Digita nome e slug
3. Clica "Criar espaÃ§o de trabalho"
4. Verifica: workspace existe? SIM âœ…
5. Toast: "Usando workspace existente!"
6. Usa workspace jÃ¡ criado
7. AvanÃ§a para prÃ³ximo passo
8. SEM ERRO! ğŸ‰
```

CENÃRIO 3: LOGOUT E LOGIN NOVAMENTE
```
1. UsuÃ¡rio faz login
2. JÃ¡ tem workspace criado
3. Sistema verifica onboarding
4. Workspace jÃ¡ existe? SIM âœ…
5. Usa workspace existente
6. Continua onboarding ou vai para dashboard
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š DIAGRAMA DO FLUXO:

```
                    Passo 2: Workspace
                            â†“
              [UsuÃ¡rio preenche formulÃ¡rio]
                            â†“
              [Clica "Criar espaÃ§o de trabalho"]
                            â†“
              [Verificar workspace existente]
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â†“               â†“
            [Existe?]           [NÃ£o existe?]
                â†“                   â†“
        [Usar existente]      [Criar novo]
                â†“                   â†“
        Toast: "Usando         Upload logo
        workspace              Criar workspace
        existente!"            Adicionar membro
                â†“                   â†“
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
              [AvanÃ§ar para prÃ³ximo passo]
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’» CÃ“DIGO COMPLETO:

```typescript
const handleNext = async () => {
  if (!name.trim()) {
    toast.error('Digite um nome para o workspace')
    return
  }

  if (!slug.trim()) {
    toast.error('Digite um slug para o workspace')
    return
  }

  if (!user) return

  setLoading(true)

  try {
    console.log('ğŸ¢ Verificando workspace existente...')
    
    // âœ… VERIFICAÃ‡ÃƒO ADICIONADA AQUI
    const { data: existingMembership, error: membershipError } = await supabase
      .from('workspace_members')
      .select('workspace_id, workspaces(id, name, slug)')
      .eq('user_id', user.id)
      .limit(1)
      .maybeSingle()

    // Se jÃ¡ tem workspace, usar o existente
    if (existingMembership && existingMembership.workspaces) {
      const workspace = existingMembership.workspaces as any
      console.log('âœ… Workspace jÃ¡ existe:', workspace.name)
      toast.success('Usando workspace existente!')
      
      onNext({
        workspaceName: workspace.name,
        workspaceId: workspace.id
      })
      return // âš ï¸ IMPORTANTE: PARAR AQUI
    }

    console.log('ğŸ¢ Criando novo workspace:', name.trim())

    // Upload do logo se existir
    let logoUrl = null
    if (logo) {
      const fileExt = logo.name.split('.').pop()
      const fileName = `${user.id}-${Date.now()}.${fileExt}`
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('workspace-logos')
        .upload(fileName, logo)

      if (uploadError) {
        console.warn('âš ï¸ Erro ao fazer upload do logo:', uploadError)
      } else {
        const { data: { publicUrl } } = supabase.storage
          .from('workspace-logos')
          .getPublicUrl(fileName)
        logoUrl = publicUrl
      }
    }

    // Criar workspace usando RPC function
    const { data: workspaceId, error } = await supabase.rpc('create_workspace_with_owner', {
      workspace_name: name.trim(),
      workspace_slug: slug.trim(),
      workspace_description: null
    })

    if (error) {
      console.error('âŒ Erro ao criar workspace:', error.message, error)
      throw error
    }

    // Atualizar avatar se logo foi enviado
    if (logoUrl && workspaceId) {
      await supabase
        .from('workspaces')
        .update({ avatar_url: logoUrl })
        .eq('id', workspaceId)
    }

    console.log('âœ… Workspace criado com sucesso:', workspaceId)

    toast.success('Workspace criado!')
    
    onNext({
      workspaceName: name,
      workspaceId: workspaceId
    })
  } catch (error: any) {
    console.error('âŒ Erro ao criar workspace:', error)
    toast.error(`Erro ao criar workspace: ${error.message || 'Erro desconhecido'}`)
  } finally {
    setLoading(false)
  }
}
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” LOGS DE DEBUG:

ANTES (COM ERRO):
```
ğŸ¢ Criando workspace: Meu Workspace
âŒ Erro ao criar workspace: duplicate key value violates unique constraint 
"workspace_members_workspace_id_user_id_key"
```

AGORA (SEM ERRO):
```
ğŸ¢ Verificando workspace existente...
âœ… Workspace jÃ¡ existe: Meu Workspace
Toast: "Usando workspace existente!"
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ CASOS ESPECIAIS:

1. USUÃRIO TEM WORKSPACE MAS VOLTA AO PASSO:
   - Verifica e usa existente
   - NÃ£o tenta criar duplicado
   - Toast: "Usando workspace existente!"

2. ERRO NA VERIFICAÃ‡ÃƒO:
   - Se erro ao buscar workspace_members
   - Tenta criar novo (comportamento padrÃ£o)
   - Se der erro 409, usuÃ¡rio vÃª mensagem clara

3. MÃšLTIPLOS WORKSPACES:
   - Query usa .limit(1).maybeSingle()
   - Pega apenas o primeiro workspace
   - Evita problemas com mÃºltiplos resultados

4. WORKSPACE DELETADO:
   - Se workspace foi deletado mas membro existe
   - workspaces serÃ¡ null
   - Cria novo workspace normalmente

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ§ª COMO TESTAR:

1. PRIMEIRA VEZ (CRIAR NOVO):
   ```
   - Login como usuÃ¡rio novo
   - Passo 2: Digite nome e slug
   - Clica "Criar espaÃ§o de trabalho"
   - Deve criar com sucesso
   - Console: "ğŸ¢ Criando novo workspace"
   ```

2. SEGUNDA VEZ (USAR EXISTENTE):
   ```
   - F5 (refresh) ou voltar ao passo 2
   - Passo 2: Digite qualquer nome
   - Clica "Criar espaÃ§o de trabalho"
   - Toast: "Usando workspace existente!"
   - Console: "âœ… Workspace jÃ¡ existe"
   - NÃƒO dÃ¡ erro 409
   ```

3. VERIFICAR NO SUPABASE:
   ```sql
   -- Ver workspace criado
   SELECT * FROM workspaces WHERE id IN (
     SELECT workspace_id FROM workspace_members 
     WHERE user_id = '[seu_user_id]'
   );

   -- Ver workspace_members
   SELECT * FROM workspace_members WHERE user_id = '[seu_user_id]';
   ```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… RESULTADO FINAL:

ANTES:
- âŒ Erro 409 ao tentar criar workspace novamente
- âŒ UsuÃ¡rio preso no passo 2
- âŒ Mensagem de erro confusa

AGORA:
- âœ… Verifica workspace existente primeiro
- âœ… Usa existente se jÃ¡ criou
- âœ… SÃ³ cria novo se nÃ£o existir
- âœ… Toast amigÃ¡vel: "Usando workspace existente!"
- âœ… Sem erro 409
- âœ… Fluxo suave e robusto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ BENEFÃCIOS:

1. EVITA ERRO 409: Nunca mais tenta criar duplicado
2. EXPERIÃŠNCIA MELHOR: Toast amigÃ¡vel ao invÃ©s de erro
3. IDEMPOTENTE: Pode clicar mÃºltiplas vezes sem problema
4. ROBUSTO: Funciona em todos os cenÃ¡rios
5. LOGS CLAROS: FÃ¡cil de debugar

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‰ PROBLEMA RESOLVIDO!

Erro 409 de workspace duplicado eliminado
VerificaÃ§Ã£o inteligente implementada
Fluxo robusto e amigÃ¡vel

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
